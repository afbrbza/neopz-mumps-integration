<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analysis - Pardiso vs Mumps Solvers</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 50px;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .summary-card h3 {
            color: #764ba2;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .summary-card .subtitle {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .insights {
            background: #fff9e6;
            border-left: 5px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .insights h3 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .insights ul {
            margin-left: 20px;
        }

        .insights li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .recommendation {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendation h3 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .warning {
            background: #ffebee;
            border-left: 5px solid #f44336;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .warning h3 {
            color: #c62828;
            margin-bottom: 10px;
        }

        .filter-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-panel label {
            display: inline-block;
            margin-right: 15px;
            font-weight: bold;
            color: #555;
        }

        .filter-panel select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
            margin-right: 20px;
            background: white;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .highlight-best {
            background: #c8e6c9 !important;
            font-weight: bold;
        }

        .highlight-worst {
            background: #ffcdd2 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä Comparative Performance Analysis</h1>
            <p>Pardiso vs Mumps - Different Architectures and Configurations</p>
            <a href="./" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: white; color: #667eea; text-decoration: none; border-radius: 5px; font-weight: bold; transition: transform 0.3s ease;">‚Üê Back Home</a>
        </div>

        <div class="content">
            <!-- Executive Summary -->
            <div class="section">
                <h2>üéØ Executive Summary</h2>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <!-- Performance by Chip -->
            <div class="section">
                <h2>‚ö° Performance by Architecture</h2>
                <div class="chart-container">
                    <div id="chipComparison"></div>
                </div>

                <div class="insights">
                    <h3>üí° Key Insights</h3>
                    <ul id="chipInsights"></ul>
                </div>
            </div>

            <!-- Performance vs Threads -->
            <div class="section">
                <h2>üîÑ Scalability with Threads</h2>
                <div class="filter-panel">
                    <label>Chip:</label>
                    <select id="chipFilter">
                        <option value="all">All</option>
                        <option value="Linux i9 12900">Linux i9 12900</option>
                        <option value="Apple M4">Apple M4</option>
                        <option value="Apple M1">Apple M1</option>
                    </select>

                    <label>Configuration:</label>
                    <select id="configFilter">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="chart-container">
                    <div id="threadPerformance"></div>
                </div>
            </div>

            <!-- Performance vs Problem Size -->
            <div class="section">
                <h2>üìà Performance vs Problem Size</h2>
                <div class="chart-container">
                    <div id="problemSizePerformance"></div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="section">
                <h2>üìã Detailed Data</h2>
                <div style="overflow-x: auto;">
                    <table id="detailTable"></table>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="section">
                <h2>üíº Recommendations</h2>
                <div id="recommendations"></div>
            </div>
        </div>
    </div>

    <script>
        (async () => {
            const res = await fetch('benchmark_analysis.csv');

            if (!res.ok) {
                console.error('Failed to load data file.');
                return;
            }

            // Parse CSV data
            const csvData = await res.text();

            const data = csvData.split('\n').map(line => {
                const parts = line.split(',');
                return {
                    solver: parts[0],
                    chip: parts[1],
                    nelDiv: parseInt(parts[2]),
                    pOrder: parseInt(parts[3]),
                    equations: parseInt(parts[4]),
                    nonZeros: parseInt(parts[5]),
                    threads: parseInt(parts[6]),
                    ordering: parts[7],
                    factorizationTime: parseFloat(parts[8]),
                    solveTime: parseFloat(parts[9]),
                    config: `${parts[2]}/${parts[3]}`
                };
            });

            // Generate summary statistics
            function generateSummary() {
                const summaryGrid = document.getElementById('summaryGrid');

                // Best overall time
                const bestTime = Math.min(...data.map(d => d.solveTime));
                const bestRun = data.find(d => d.solveTime === bestTime);

                // Average speedup of Pardiso over Mumps on i9
                const i9Pardiso = data.filter(d => d.solver === 'Pardiso' && d.chip === 'Linux i9 12900');
                const i9Mumps = data.filter(d => d.solver === 'Mumps' && d.chip === 'Linux i9 12900');

                const avgPardisoTime = i9Pardiso.reduce((sum, d) => sum + d.solveTime, 0) / i9Pardiso.length;
                const avgMumpsTime = i9Mumps.reduce((sum, d) => sum + d.solveTime, 0) / i9Mumps.length;
                const speedup = ((avgMumpsTime - avgPardisoTime) / avgMumpsTime * 100).toFixed(1);

                // Total configurations tested
                const totalTests = data.length;

                // Anomalies detected
                const anomalies = data.filter(d =>
                    (d.chip.includes('Apple') && d.threads >= 6 && d.solveTime > 1000)
                ).length;

                summaryGrid.innerHTML = `
                <div class="summary-card">
                    <h3>Best Performance</h3>
                    <div class="value">${bestTime.toFixed(2)}s</div>
                    <div class="subtitle">${bestRun.solver} on ${bestRun.chip} (${bestRun.threads} threads)</div>
                </div>
                <div class="summary-card">
                    <h3>Pardiso Advantage (i9)</h3>
                    <div class="value">${speedup}%</div>
                    <div class="subtitle">Faster than Mumps on average</div>
                </div>
                <div class="summary-card">
                    <h3>Configurations Tested</h3>
                    <div class="value">${totalTests}</div>
                    <div class="subtitle">Different combinations</div>
                </div>
                <div class="summary-card">
                    <h3>Anomalies Detected</h3>
                    <div class="value">${anomalies}</div>
                    <div class="subtitle">Issues on Apple Silicon</div>
                </div>
            `;
            }

            // Generate chip comparison chart
            function generateChipComparison() {
                const chips = [...new Set(data.map(d => d.chip))];
                const solvers = [...new Set(data.map(d => d.solver))];

                const traces = [];

                solvers.forEach(solver => {
                    const avgTimes = chips.map(chip => {
                        const filtered = data.filter(d =>
                            d.solver === solver &&
                            d.chip === chip &&
                            d.solveTime < 1000 // Exclude anomalies for cleaner view
                        );
                        return filtered.length > 0
                            ? filtered.reduce((sum, d) => sum + d.solveTime, 0) / filtered.length
                            : 0;
                    });

                    traces.push({
                        x: chips,
                        y: avgTimes,
                        name: solver,
                        type: 'bar',
                        text: avgTimes.map(t => t.toFixed(2) + 's'),
                        textposition: 'auto',
                    });
                });

                const layout = {
                    title: 'Average Solve Time by Architecture (excluding anomalies)',
                    xaxis: { title: 'Architecture' },
                    yaxis: { title: 'Time (seconds)' },
                    barmode: 'group',
                    height: 500,
                    showlegend: true
                };

                Plotly.newPlot('chipComparison', traces, layout, { responsive: true });

                // Generate insights
                const insightsList = document.getElementById('chipInsights');
                insightsList.innerHTML = `
                <li><strong>Intel i9 12900 + Pardiso</strong> consistently delivers the best solve times.</li>
                <li><strong>Apple M4 and M1</strong> show competitive performance with Mumps at low parallelization (1-4 threads).</li>
                <li><strong>Pardiso is only available on Linux</strong>, limiting options on Apple hardware.</li>
                <li><strong>Apple Silicon performance degrades severely</strong> with 6+ threads in Mumps.</li>
            `;
            }

            // Generate thread performance chart
            function updateThreadChart() {
                const chipFilter = document.getElementById('chipFilter').value;
                const configFilter = document.getElementById('configFilter').value;

                let filtered = data;
                if (chipFilter !== 'all') {
                    filtered = filtered.filter(d => d.chip === chipFilter);
                }
                if (configFilter !== 'all') {
                    filtered = filtered.filter(d => d.config === configFilter);
                }

                const groups = {};
                filtered.forEach(d => {
                    const key = `${d.solver}-${d.chip}-${d.config}`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(d);
                });

                const traces = [];
                Object.keys(groups).forEach(key => {
                    const group = groups[key].sort((a, b) => a.threads - b.threads);
                    traces.push({
                        x: group.map(d => d.threads),
                        y: group.map(d => d.solveTime),
                        name: key.replace(/-/g, ' - '),
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { width: 2 },
                        marker: { size: 8 }
                    });
                });

                const layout = {
                    title: 'Performance vs Number of Threads',
                    xaxis: { title: 'Number of Threads' },
                    yaxis: {
                        title: 'Solve Time (seconds)',
                        type: 'log'
                    },
                    height: 500,
                    showlegend: true,
                    hovermode: 'closest'
                };

                Plotly.newPlot('threadPerformance', traces, layout, { responsive: true });
            }

            // Generate problem size chart
            function generateProblemSizeChart() {
                const configs = [...new Set(data.map(d => d.config))].sort();

                const pardisoI9 = configs.map(config => {
                    const filtered = data.filter(d =>
                        d.solver === 'Pardiso' &&
                        d.chip === 'Linux i9 12900' &&
                        d.config === config &&
                        d.threads === 4
                    );
                    return filtered.length > 0 ? filtered[0].solveTime : null;
                });

                const mumpsI9 = configs.map(config => {
                    const filtered = data.filter(d =>
                        d.solver === 'Mumps' &&
                        d.chip === 'Linux i9 12900' &&
                        d.config === config &&
                        d.threads === 4
                    );
                    return filtered.length > 0 ? filtered[0].solveTime : null;
                });

                const mumpsM4 = configs.map(config => {
                    const filtered = data.filter(d =>
                        d.solver === 'Mumps' &&
                        d.chip === 'Apple M4' &&
                        d.config === config &&
                        d.threads === 4 &&
                        d.solveTime < 1000
                    );
                    return filtered.length > 0 ? filtered[0].solveTime : null;
                });

                const traces = [
                    {
                        x: configs,
                        y: pardisoI9,
                        name: 'Pardiso (i9, 4 threads)',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { width: 3 },
                        marker: { size: 10 }
                    },
                    {
                        x: configs,
                        y: mumpsI9,
                        name: 'Mumps (i9, 4 threads)',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { width: 3 },
                        marker: { size: 10 }
                    },
                    {
                        x: configs,
                        y: mumpsM4,
                        name: 'Mumps (M4, 4 threads)',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { width: 3 },
                        marker: { size: 10 }
                    }
                ];

                const layout = {
                    title: 'Performance vs Problem Configuration (4 threads)',
                    xaxis: { title: 'Configuration (nelDiv/pOrder)' },
                    yaxis: { title: 'Solve Time (seconds)' },
                    height: 500,
                    showlegend: true
                };

                Plotly.newPlot('problemSizePerformance', traces, layout, { responsive: true });
            }

            // Generate detailed table
            function generateTable() {
                const table = document.getElementById('detailTable');

                // Sort by solve time
                const sorted = [...data].sort((a, b) => a.solveTime - b.solveTime);

                const bestTime = sorted[0].solveTime;
                const worstNormalTime = sorted.filter(d => d.solveTime < 1000).slice(-1)[0].solveTime;

                let html = `
                <thead>
                    <tr>
                        <th>Solver</th>
                        <th>Chip</th>
                        <th>Config</th>
                        <th>Threads</th>
                        <th>Equations</th>
                        <th>Factorization (s)</th>
                        <th>Total Time (s)</th>
                        <th>Speedup <span title="Calculated as: Slowest Time √∑ Current Time" style="cursor: help;">‚ÑπÔ∏è</span></th>
                    </tr>
                </thead>
                <tbody>
            `;

                sorted.forEach(d => {
                    const speedup = (sorted[sorted.length - 1].solveTime / d.solveTime).toFixed(2);
                    const rowClass = d.solveTime === bestTime ? 'highlight-best' :
                        (d.solveTime > 1000 ? 'highlight-worst' : '');

                    html += `
                    <tr class="${rowClass}">
                        <td>${d.solver}</td>
                        <td>${d.chip}</td>
                        <td>${d.config}</td>
                        <td>${d.threads}</td>
                        <td>${d.equations.toLocaleString()}</td>
                        <td>${d.factorizationTime.toFixed(2)}</td>
                        <td>${d.solveTime.toFixed(2)}</td>
                        <td title="Slowest: ${sorted[sorted.length - 1].solveTime.toFixed(2)}s √∑ This: ${d.solveTime.toFixed(2)}s" style="cursor: help;">${speedup}x</td>
                    </tr>
                `;
                });

                html += '</tbody>';
                table.innerHTML = html;
            }

            // Generate recommendations
            function generateRecommendations() {
                const container = document.getElementById('recommendations');

                container.innerHTML = `
                <div class="recommendation">
                    <h3>‚úÖ For Linux Production</h3>
                    <p><strong>Recommendation:</strong> Use Pardiso on Intel i9 12900 with 4-6 threads.</p>
                    <ul>
                        <li>Delivers best overall performance (~110-130s for large problems)</li>
                        <li>Consistent scalability up to 6 threads</li>
                        <li>Performance diminishes after 6 threads due to parallelization overhead</li>
                    </ul>
                </div>
                
                <div class="recommendation">
                    <h3>‚úÖ For Apple Silicon Development</h3>
                    <p><strong>Recommendation:</strong> Use Mumps with 1-4 threads on M4 or M1.</p>
                    <ul>
                        <li>Acceptable performance for development (~130-190s)</li>
                        <li>M4 shows slight advantage over M1 in some cases</li>
                        <li><strong>Critical:</strong> Do not exceed 4 threads to avoid severe degradation</li>
                    </ul>
                </div>
                
                <div class="warning">
                    <h3>‚ö†Ô∏è Identified Issues</h3>
                    <ul>
                        <li><strong>Apple Silicon + Mumps with 6+ threads:</strong> Catastrophic performance degradation (up to 40x slower)</li>
                        <li>Likely synchronization or memory contention issue</li>
                        <li>Requires additional investigation or runtime thread limitation</li>
                        <li><strong>Immediate recommendation:</strong> Add code verification to limit threads on Apple Silicon</li>
                    </ul>
                </div>
                
                <div class="recommendation">
                    <h3>üéØ Next Steps</h3>
                    <ul>
                        <li>Investigate root cause of Apple Silicon degradation with high parallelization</li>
                        <li>Test Pardiso on other Linux platforms to confirm results</li>
                        <li>Consider implementing automatic platform detection to adjust threads</li>
                        <li>Evaluate cost-benefit of dedicated Linux hardware vs Apple for production</li>
                    </ul>
                </div>
            `;
            }

            // Populate config filter
            function populateConfigFilter() {
                const configs = [...new Set(data.map(d => d.config))].sort();
                const select = document.getElementById('configFilter');
                configs.forEach(config => {
                    const option = document.createElement('option');
                    option.value = config;
                    option.textContent = `${config} (nelDiv/pOrder)`;
                    select.appendChild(option);
                });
            }

            // Initialize
            generateSummary();
            generateChipComparison();
            populateConfigFilter();
            updateThreadChart();
            generateProblemSizeChart();
            generateTable();
            generateRecommendations();

            document.getElementById("chipFilter").addEventListener('change', updateThreadChart);
            document.getElementById("configFilter").addEventListener('change', updateThreadChart);
        })();
    </script>
</body>

</html>